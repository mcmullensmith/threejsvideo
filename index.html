<html>
<head>
  <title>ThreeJS Video Experiment</title>

  <style>
    body {
      background-color: #000;
      color: #fff;
      margin: 0px;
      overflow: hidden;
      font-family:Monospace;
      font-size:13px;
      text-align:center;
      font-weight: bold;
      text-align:center;
    }

    .foo{
        opacity: 0;
    }

      video, canvas{
          width: 100%;
          height: auto;
      }
      .vr-video{
          position: absolute;
          opacity: 0;
      }
        #regular{
          position: fixed;
          z-index: 99;
      }

  </style>
</head>
<body>

<div class="vr-video">
    <div id="container"></div>
</div>

<div class="js-video">
    <div id="regular">
        <canvas id="canvasID"></canvas>
    </div>
</div>

<video id="vr-video" loop webkit-playsinline style="display:none"></video>


<video id="video" autoplay loop webkit-playsinline style="display:none"></video>

  <script src="js/three.min.js" type="text/javascript"></script>

  <script src="js/controls/VRControls.js"></script>
  <script src="js/effects/VREffect.js"></script>
  <script src="js/vr/WebVR.js"></script>


<script src="js/webvr-polyfill.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TimelineLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/easing/EasePack.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/plugins/CSSPlugin.min.js"></script>

  <script type="text/javascript">
      (function() {

          if (WEBVR.isAvailable() === false) {
              document.body.appendChild(WEBVR.getMessage());
          }
          //
          var camera, scene, renderer;
          var video, texture, effect;
          var controls;
          init();
          animate();
          function init() {
              var container = document.getElementById('container');
              container.addEventListener('click', function () {
                  video.play();
              });
              camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.001, 10000);
              camera.layers.enable(1); // render left view when no stereo available

              // video
              video = document.getElementById('vr-video');
              video.loop = true;
              video.width = 1280;
              video.height = 720;
              video.muted = true;
              video.src = 'textures/Climb On in 360u00ba - White Water Kayaking.mp4';
              video.setAttribute('webkit-playsinline', 'webkit-playsinline');

              texture = new THREE.VideoTexture(video);
              texture.minFilter = THREE.NearestFilter;
              texture.maxFilter = THREE.NearestFilter;


              texture.format = THREE.RGBFormat;
              texture.generateMipmaps = false;
              scene = new THREE.Scene();
              window.scene = scene;
              window.THREE = THREE;
              // left
              var geometry = new THREE.SphereGeometry(500, 60, 40);
              geometry.scale(-1, 1, 1);


//              var uvs = geometry.faceVertexUvs[0];
//              for (var i = 0; i < uvs.length; i++) {
//                  for (var j = 0; j < 3; j++) {
//                      uvs[i][j].x *= 0.5;
//                  }
//              }
              var material = new THREE.MeshBasicMaterial({map: texture});
              var mesh = new THREE.Mesh(geometry, material);
              mesh.rotation.y = -Math.PI / 2;
              mesh.layers.set(1); // display in left eye only
              scene.add(mesh);
              // right
              var geometry = new THREE.SphereGeometry(500, 60, 40);
              geometry.scale(-1, 1, 1);


//              var uvs = geometry.faceVertexUvs[0];
//              for (var i = 0; i < uvs.length; i++) {
//                  for (var j = 0; j < 3; j++) {
//                      uvs[i][j].x *= 0.5;
//                      uvs[i][j].x += 0.5;
//                  }
//              }
              var material = new THREE.MeshBasicMaterial({map: texture});
              var mesh = new THREE.Mesh(geometry, material);
              mesh.rotation.y = -Math.PI / 2;
              mesh.layers.set(2); // display in right eye only
              scene.add(mesh);
              //
              renderer = new THREE.WebGLRenderer();
              renderer.setClearColor(0x101010);
              renderer.setPixelRatio(window.devicePixelRatio);
              renderer.setSize(window.innerWidth, window.innerHeight);
              container.appendChild(renderer.domElement);
              //
              controls = new THREE.VRControls(camera);
              effect = new THREE.VREffect(renderer);
              effect.scale = 0; // video doesn't need eye separation
              effect.setSize(window.innerWidth, window.innerHeight);

              if ( WEBVR.isAvailable() === true ) {

                  container.appendChild( WEBVR.getButton( effect ) );

              }

              window.addEventListener('resize', onWindowResize, false);
          }

          function onWindowResize() {
              camera.aspect = window.innerWidth / window.innerHeight;
              camera.updateProjectionMatrix();
              effect.setSize(window.innerWidth, window.innerHeight);
          }

          function animate() {
              effect.requestAnimationFrame(animate);

              render();
          }

          function render() {
              controls.update();
              effect.render(scene, camera);

          }
      })();

  </script>

<script type="text/javascript">
    (function() {
        var container;
        var camera, scene, renderer;
        var video, texture;
        var toggled = false;
        var button;

        init();
        animate();
        function init(){


            container = document.getElementById( 'regular' );
            document.body.appendChild( container );

            var vrvideo = document.querySelector('.vr-video');

            container.addEventListener("mousedown", function(){

                if(!toggled){

                    TweenLite.to('#regular', 1 ,{opacity: 0});

                    toggled = true;
                    vrvideo.style.opacity = 1;
                }

            });

            container.addEventListener("mouseup", function() {
                button = document.getElementsByClassName('foo');
                if(toggled){

                    TweenLite.to('#regular', 1 ,{opacity: 1});
                    toggled = false;
                    vrvideo.style.opacity = 0;
                }
            });

            camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
            camera.position.z = 1000;

            scene = new THREE.Scene();

            scene.add(camera);

            var light = new THREE.DirectionalLight( 0xffffff );
            light.position.set( 0.5, 1, 1 ).normalize();
            scene.add( light );

            var canvas = document.getElementById("canvasID");
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: false });
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            container.appendChild( renderer.domElement );

            video = document.getElementById( 'video' );
            video.src ="textures/GearVR-VeilHymm-Loop.mp4?_ijt=5dqcnvt7skbm0u3cc4bc96u04t";
            video.setAttribute('crossorigin', 'anonymous');
            video.loop = true;
            video.load(); // must call after setting/changing source
            video.play();
            video.setAttribute('crossorigin', 'anonymous');

            texture = new THREE.VideoTexture( video );
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;
            texture.format = THREE.RGBFormat;

            renderer.autoClear = false;

            var movieMaterial = new THREE.MeshBasicMaterial( { map: texture, overdraw: true, side:THREE.DoubleSide } );
            // the geometry on which the movie will be displayed;
            // 		movie image will be scaled to fit these dimensions.
            var movieGeometry = new THREE.PlaneGeometry( 1440, 900, 0, 0 );
            var movieScreen = new THREE.Mesh( movieGeometry, movieMaterial );
            movieScreen.position.set(0,0,0);

            scene.add(movieScreen);
            camera.lookAt(movieScreen.position);

            window.addEventListener('resize', onWindowResize, false);

        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }

        function animate() {
            requestAnimationFrame( animate );
            render();
        }

        function render() {
            renderer.render( scene, camera );
        }

    })();



</script>
</body>
</html>
